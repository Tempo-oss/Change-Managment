<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChangeSync - Change Integration Hub</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900 min-h-screen flex">

    <!-- Sidebar -->
    <aside class="w-64 bg-slate-900 text-slate-300 flex-col hidden md:flex h-screen sticky top-0">
        <div class="p-6 border-b border-slate-800 flex items-center gap-3">
            <div class="bg-indigo-500 p-2 rounded-lg">
                <i class="ph-bold ph-list-checks text-white text-xl"></i>
            </div>
            <span class="text-xl font-bold text-white tracking-wide">ChangeSync</span>
        </div>
        
        <nav class="flex-1 py-6 px-4 space-y-2" id="nav-menu">
            <!-- Nav buttons injected via JS -->
        </nav>
        
        <div class="p-4 border-t border-slate-800">
            <div class="flex items-center gap-3 px-4 py-2">
                <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-sm font-bold text-white border border-slate-600">
                    CI
                </div>
                <div class="text-sm">
                    <p class="font-semibold text-white">Integration Mgr</p>
                    <p class="text-xs text-slate-500">Admin</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto min-h-screen relative">
        <div id="supabase-banner" class="bg-amber-100 text-amber-800 text-sm px-4 py-2 text-center font-medium hidden">
            Running in Local Prototype Mode. Add Supabase keys to enable cloud sync.
        </div>
        <div class="max-w-6xl mx-auto p-6 md:p-10" id="app-root">
            <!-- Content injected via JS -->
        </div>
    </main>

    <script>
        // ==========================================
        // CONFIGURATION & SETUP
        // ==========================================
        
        // ADD YOUR SUPABASE KEYS HERE
        const SUPABASE_URL = 'https://paplnlekrwscsxnxiviz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBhcGxubGVrcndzY3N4bnhpdml6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NTA2ODgsImV4cCI6MjA4NzUyNjY4OH0.HJ9izkfAqmcSnekGVA-Trg6MSBW-m7PwTQByEHXJZ-o';
        
        let supabaseClient = null;
        let isConnectedToSupabase = false;

        if (SUPABASE_URL !== 'YOUR_SUPABASE_URL' && SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY') {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            isConnectedToSupabase = true;
        } else {
            document.getElementById('supabase-banner').classList.remove('hidden');
        }

        // ==========================================
        // STATE MANAGEMENT
        // ==========================================
        let state = {
            currentView: 'dashboard',
            projects: [],
            selectedProjectId: null,
            importType: 'manual',
            isImporting: false,
            fetchedPRDs: [
                { id: 'prd-1', title: 'Referral Program 2.0', category: 'Growth & Acquisition', objective: 'Revamp the referral program to offer tiered rewards and increase user acquisition.', scope: 'Mobile app, Marketing emails, Billing platform.', techSummary: 'Update referral code generation logic and webhook listeners for successful conversions.', timeline: '2026-06-15', dependencies: 'Stripe API update', riskLevel: 'Medium' },
                { id: 'prd-2', title: 'AI Coach V2', category: 'Core Experience', objective: 'Implement AI coaching models into the primary mobile user experience to boost retention.', scope: 'Mobile app exclusively. Requires backend ML support.', techSummary: 'Integrating generative AI endpoints to build custom workout summaries. Dependent on data engineering pipelines.', timeline: '2026-11-01', dependencies: 'ML Model V2, Mobile iOS Release 4.1', riskLevel: 'High' },
                { id: 'prd-3', title: 'Workout History Export', category: 'Core Experience', objective: 'Allow users to export their workout data to Apple Health and CSV.', scope: 'iOS App and User Web Portal.', techSummary: 'Implement HealthKit integration and a CSV generation microservice.', timeline: '2026-05-20', dependencies: 'None', riskLevel: 'Low' },
                { id: 'prd-4', title: 'Payment Gateway Migration', category: 'Platform & Infrastructure', objective: 'Migrate core payment processing to Stripe to reduce transaction fees.', scope: 'All NA and EU transactions.', techSummary: 'API swap from LegacyPay to Stripe V3. Requires new webhook handling.', timeline: '2026-08-01', dependencies: 'Finance Team Approval', riskLevel: 'High' }
            ],
            formData: {
                title: '', objective: '', scope: '', techSummary: '', timeline: '', dependencies: '', riskLevel: 'Medium'
            },
            importUrl: '',
            // New State for Internal Changes
            internalChanges: [],
            showInternalChangeForm: false,
            expandedChangeId: null,
            internalFormData: {
                title: '', team: 'All Tiers', type: 'Workflow', date: '', submitter: '', description: '', link: '', impact: 'Minor', isCustomerFacing: false
            }
        };

        const generateMxActions = (impact, type) => {
            let actions = [
                { task: 'Create Slack channel for internal communication', owner: 'Submitter / Dept Head', time: '5m', status: 'Pending', isEditing: false },
                { task: 'Announce the change', owner: 'Change Owner', time: '10m', status: 'Pending', isEditing: false },
                { task: 'Update the Change Communication Tracker', owner: 'Manager', time: '5m', status: 'Pending', isEditing: false }
            ];

            if (impact === 'Major' || impact === 'Critical') {
                actions.push({ task: 'Document to outline flows and requirements', owner: 'Change Owner', time: '1h', status: 'Pending', isEditing: false });
                actions.push({ task: 'Huddle with impacted teams', owner: 'Manager', time: '15m per interval', status: 'Pending', isEditing: false });
                actions.push({ task: 'Training materials or sessions', owner: 'Training Dept', time: 'TBD', status: 'Pending', isEditing: false });
                actions.push({ task: 'Testing system workflows & collecting samples', owner: 'QA / Operations', time: 'TBD', status: 'Pending', isEditing: false });
            }

            if (type === 'Workflow') {
                if (impact === 'Minor') {
                    actions.push({ task: 'Updating current SOP/s', owner: 'Submitter', time: '10 - 30m per page', status: 'Pending', isEditing: false });
                } else {
                    actions.push({ task: 'Creating a new SOP', owner: 'Operations', time: '30m - 1h', status: 'Pending', isEditing: false });
                }
                actions.push({ task: 'QA scorecard modifications', owner: 'Quality', time: '30m', status: 'Pending', isEditing: false });
            }
            return actions;
        };

        const initialInternalChanges = [
            {
                id: 'ic-1', title: 'Start new conversations using Freshchat instead of Follow-Up Emails', team: 'All Tiers', type: 'Workflow', date: '2023-12-27T17:00', submitter: 'Khaled El Sabban', 
                description: 'We donâ€™t need to make Follow-Up Emails anymore. Now, we can start new conversations using Freshchat (+New conv Feature). All Agents should use this new feature instead of sending Follow-Up Emails. This will reduce the impact of receiving more than one open conversation under the same customer, along with many challenges related to queues automation and snoozing interactions.', 
                link: 'https://tempofit.atlassian.net/wiki/spaces/CS/pages/904757249/Creating+A+Follow-Up+Email', impact: 'Major', isCustomerFacing: false,
                actions: generateMxActions('Major', 'Workflow')
            },
            {
                id: 'ic-2', title: 'Update SOP - Holding and Postponing Deliveries', team: 'All Tiers', type: 'Workflow', date: '2024-05-21T00:00', submitter: 'Ahmed Hamed', 
                description: 'For Pre assigned units, we need to add the extra step of raising the request to T2 Mentors for support. Mentors must notify Logistics team on #Mx-Sc-Studio slack channel.', 
                link: '', impact: 'Minor', isCustomerFacing: false,
                actions: generateMxActions('Minor', 'Workflow')
            },
            {
                id: 'ic-3', title: 'Order Confirmation Page', team: 'All Tiers', type: 'System/Tools', date: '2024-09-03T21:00', submitter: 'Mohamed Amin', 
                description: 'I can see we have outdated delivery information in the order confirmation page that appears to customers, as you see in the attached screenshot.', 
                link: 'https://shop.tempo.fit/27218149465/orders/3f1110579a98e993c44d69fb1b4ee7b9', impact: 'Critical', isCustomerFacing: true,
                actions: generateMxActions('Critical', 'System/Tools')
            },
            {
                id: 'ic-4', title: 'Sales SOP for follow ups', team: 'Tier 1', type: 'Workflow', date: '2024-11-27T18:00', submitter: 'Ahmed Elsawy', 
                description: 'Updating the sales SOP for follow ups to align with new communication strategies.', 
                link: 'https://docs.google.com/document/d/13hJwCHw6AjU2GXmHjZfQVs68FKnHSttAhKUkr_g3CvI/edit?tab=t.0', impact: 'Minor', isCustomerFacing: false,
                actions: generateMxActions('Minor', 'Workflow')
            },
            {
                id: 'ic-5', title: 'Upgrade/Downgrade for T1', team: 'Tier 1', type: 'Workflow', date: 'Pending', submitter: 'Heba Elsobky', 
                description: 'We need to have specific guidelines related to the upgrade and downgrade process, and the steps for each scenario (Pre-shipping, Post-shipping, and Post-delivery)', 
                link: 'https://tempofit.atlassian.net/wiki/spaces/CS/pages/400328644/How+to+Edit+Order+Upgrade+Downgrade', impact: 'Major', isCustomerFacing: true,
                actions: generateMxActions('Major', 'Workflow')
            }
        ];

        const initialProjects = [
            {
                id: 'proj-1',
                title: 'Q3 Payment Gateway Migration',
                objective: 'Migrate core payment processing to Stripe to reduce transaction fees.',
                scope: 'All NA and EU transactions. Excludes APAC for now.',
                techSummary: 'API swap from LegacyPay to Stripe V3. Requires new webhook handling.',
                timeline: '2026-08-01',
                impactLevel: 'High',
                status: 'In Progress',
                approvalGate: 'Pending',
                tasks: {
                    operations: [
                        { id: 't1', title: 'SOP changes required', status: 'Completed', owner: 'Sarah J.', dueDate: '2026-06-15', type: 'ops' },
                        { id: 't2', title: 'Workflow updates', status: 'In Progress', owner: 'Mike T.', dueDate: '2026-06-20', type: 'ops' },
                        { id: 't3', title: 'Tool/process adjustments', status: 'Blocked', owner: 'Sarah J.', dueDate: '2026-06-25', type: 'ops' },
                    ],
                    training: [
                        { id: 't4', title: 'Knowledge base updates', status: 'In Progress', owner: 'David L.', dueDate: '2026-07-01', type: 'trn' },
                        { id: 't5', title: 'LMS content updates', status: 'Not Started', owner: 'Emma W.', dueDate: '2026-07-10', type: 'trn' },
                    ],
                    quality: [
                        { id: 't6', title: 'QA form adjustments', status: 'Completed', owner: 'Chris P.', dueDate: '2026-06-10', type: 'qa' },
                        { id: 't7', title: 'New audit criteria', status: 'Completed', owner: 'Chris P.', dueDate: '2026-06-12', type: 'qa' },
                    ]
                }
            }
        ];

        // ==========================================
        // CORE FUNCTIONS
        // ==========================================

        async function init() {
            if (isConnectedToSupabase) {
                const { data, error } = await supabaseClient.from('projects').select('*');
                if (error) {
                    console.error("Supabase Error:", error);
                    state.projects = [...initialProjects]; // Fallback
                } else {
                    state.projects = data || [];
                }
            } else {
                state.projects = [...initialProjects];
            }
            state.internalChanges = [...initialInternalChanges];
            render();
        }

        async function saveProjectToDB(project) {
            if (isConnectedToSupabase) {
                const { error } = await supabaseClient.from('projects').upsert(project);
                if (error) console.error("Error saving to Supabase:", error);
            }
        }

        // ==========================================
        // HELPERS
        // ==========================================
        
        const generateDefaultTasks = (dept) => {
            const ts = Date.now();
            const defaultTasks = {
                operations: [
                    { id: `ops-1-${ts}`, title: 'SOP changes required', status: 'Not Started', owner: '', dueDate: '', type: 'ops' },
                    { id: `ops-2-${ts}`, title: 'Workflow updates', status: 'Not Started', owner: '', dueDate: '', type: 'ops' },
                    { id: `ops-3-${ts}`, title: 'Tool/process adjustments', status: 'Not Started', owner: '', dueDate: '', type: 'ops' },
                    { id: `ops-4-${ts}`, title: 'Required communications', status: 'Not Started', owner: '', dueDate: '', type: 'ops' },
                    { id: `ops-5-${ts}`, title: 'Launch readiness checklist', status: 'Not Started', owner: '', dueDate: '', type: 'ops' },
                ],
                training: [
                    { id: `trn-1-${ts}`, title: 'Knowledge base updates', status: 'Not Started', owner: '', dueDate: '', type: 'trn' },
                    { id: `trn-2-${ts}`, title: 'LMS content updates', status: 'Not Started', owner: '', dueDate: '', type: 'trn' },
                    { id: `trn-3-${ts}`, title: 'Agent enablement materials', status: 'Not Started', owner: '', dueDate: '', type: 'trn' },
                    { id: `trn-4-${ts}`, title: 'Certification requirements', status: 'Not Started', owner: '', dueDate: '', type: 'trn' },
                ],
                quality: [
                    { id: `qa-1-${ts}`, title: 'QA form adjustments', status: 'Not Started', owner: '', dueDate: '', type: 'qa' },
                    { id: `qa-2-${ts}`, title: 'New audit criteria', status: 'Not Started', owner: '', dueDate: '', type: 'qa' },
                    { id: `qa-3-${ts}`, title: 'Calibration requirements', status: 'Not Started', owner: '', dueDate: '', type: 'qa' },
                    { id: `qa-4-${ts}`, title: 'Risk monitoring metrics', status: 'Not Started', owner: '', dueDate: '', type: 'qa' },
                ]
            };
            return defaultTasks[dept] || [];
        };

        const calculateReadiness = (tasks) => {
            if (!tasks || tasks.length === 0) return 0;
            const completed = tasks.filter(t => t.status === 'Completed').length;
            return Math.round((completed / tasks.length) * 100);
        };

        const calculateOverallReadiness = (projectTasks) => {
            const allTasks = [...(projectTasks.operations||[]), ...(projectTasks.training||[]), ...(projectTasks.quality||[])];
            return calculateReadiness(allTasks);
        };

        const escapeHTML = (str) => {
            return str ? str.toString().replace(/[&<>'"]/g, 
                tag => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;' }[tag] || tag)
            ) : '';
        };

        // ==========================================
        // EVENT HANDLERS (Attached to Window)
        // ==========================================

        window.navigate = (view) => {
            state.currentView = view;
            render();
        };

        window.openProject = (id) => {
            state.selectedProjectId = id;
            navigate('project-detail');
        };

        window.setImportType = (type) => {
            state.importType = type;
            state.importUrl = '';
            // Reset form if navigating away from confluence
            if(type !== 'confluence') {
                state.formData = { title: '', objective: '', scope: '', techSummary: '', timeline: '', dependencies: '', riskLevel: 'Medium' };
            }
            render();
        };

        window.handleFormInput = (name, value) => {
            state.formData[name] = value;
        };

        window.handleImportUrlInput = (value) => {
            state.importUrl = value;
            document.getElementById('import-btn').disabled = !value;
        };

        window.selectPRD = (id) => {
            const prd = state.fetchedPRDs.find(p => p.id === id);
            if(prd) {
                state.formData = {
                    title: prd.title,
                    objective: prd.objective,
                    scope: prd.scope,
                    techSummary: prd.techSummary,
                    timeline: prd.timeline,
                    dependencies: prd.dependencies,
                    riskLevel: prd.riskLevel
                };
                
                render();
                
                // Scroll down to the populated form
                setTimeout(() => {
                    document.getElementById('intake-form').scrollIntoView({ behavior: 'smooth' });
                }, 100);
            }
        };

        window.handleImport = async () => {
            if (!state.importUrl) return;
            state.isImporting = true;
            render();
            
            try {
                if (isConnectedToSupabase) {
                    console.log("Calling Edge Function with URL:", state.importUrl);
                    
                    // Call the real Supabase Edge Function
                    const { data, error } = await supabaseClient.functions.invoke('import-doc', {
                        body: { url: state.importUrl, type: state.importType }
                    });

                    console.log("Edge Function Response:", { data, error });

                    if (error) {
                        throw new Error(error.message || "Supabase invocation failed");
                    }

                    if (data && data.success) {
                        // Merge the parsed data with our form data
                        state.formData = {
                            ...state.formData,
                            title: data.parsed.title || '',
                            objective: data.parsed.objective || '',
                            scope: data.parsed.scope || '',
                            techSummary: data.parsed.techSummary || '',
                            dependencies: data.parsed.dependencies || '',
                        };
                    } else if (data && !data.success) {
                        // This will catch explicit errors from our Edge Function
                        throw new Error(data.error || "Unknown error from backend");
                    } else {
                        throw new Error("No data returned from backend");
                    }
                } else {
                    throw new Error("Supabase is not connected.");
                }
            } catch (err) {
                console.error("Failed to import document:", err);
                // Better error alert so we can see exactly what failed
                alert("Import Failed: " + err.message);
            } finally {
                state.isImporting = false;
                state.importUrl = '';
                render();
            }
        };

        window.handleFormSubmit = async (e) => {
            e.preventDefault();
            const newProject = {
                id: `proj-${Date.now()}`,
                ...state.formData,
                impactLevel: state.formData.riskLevel,
                status: 'In Progress',
                approvalGate: 'Pending',
                tasks: {
                    operations: generateDefaultTasks('operations'),
                    training: generateDefaultTasks('training'),
                    quality: generateDefaultTasks('quality'),
                }
            };
            
            state.projects.push(newProject);
            await saveProjectToDB(newProject);
            
            state.formData = { title: '', objective: '', scope: '', techSummary: '', timeline: '', dependencies: '', riskLevel: 'Medium' };
            state.importType = 'manual';
            navigate('dashboard');
        };

        window.updateTaskStatus = async (projectId, dept, taskId, newStatus) => {
            const project = state.projects.find(p => p.id === projectId);
            if (!project) return;
            
            const task = project.tasks[dept].find(t => t.id === taskId);
            if (task) task.status = newStatus;
            
            render(); // Fast UI update
            await saveProjectToDB(project); // Background save
        };

        window.updateTaskDetail = async (projectId, dept, taskId, field, value) => {
             const project = state.projects.find(p => p.id === projectId);
             if (!project) return;
             const task = project.tasks[dept].find(t => t.id === taskId);
             if (task) task[field] = value;
             await saveProjectToDB(project);
        };

        window.updateApprovalGate = async (projectId) => {
            const project = state.projects.find(p => p.id === projectId);
            if (!project) return;
            project.approvalGate = project.approvalGate === 'Go' ? 'No-Go' : 'Go';
            render();
            await saveProjectToDB(project);
        };

        // MX Internal Changes Handlers
        window.toggleInternalChangeForm = (show) => {
            state.showInternalChangeForm = show;
            if (!show) {
                // Reset form
                state.internalFormData = { title: '', team: 'All Tiers', type: 'Workflow', date: '', submitter: '', description: '', link: '', impact: 'Minor', isCustomerFacing: false };
            }
            render();
        };

        window.handleInternalChangeInput = (field, value) => {
            state.internalFormData[field] = value;
        };
        
        window.handleInternalChangeCheckbox = (field, checked) => {
            state.internalFormData[field] = checked;
        };

        window.toggleInternalChangeDetail = (id) => {
            state.expandedChangeId = state.expandedChangeId === id ? null : id;
            render();
        };

        window.submitInternalChange = (e) => {
            e.preventDefault();
            const newChange = {
                id: `ic-${Date.now()}`,
                ...state.internalFormData,
                actions: generateMxActions(state.internalFormData.impact, state.internalFormData.type)
            };
            
            // Unshift to put at the top of the list
            state.internalChanges.unshift(newChange);
            
            // In a real app, you would save this to Supabase here
            window.toggleInternalChangeForm(false);
        };

        // Action Plan Edit Handlers
        window.deleteMxAction = (changeId, actionIndex) => {
            const change = state.internalChanges.find(c => c.id === changeId);
            if (change) {
                change.actions.splice(actionIndex, 1);
                render();
            }
        };

        window.editMxAction = (changeId, actionIndex) => {
            const change = state.internalChanges.find(c => c.id === changeId);
            if (change) {
                change.actions[actionIndex].isEditing = true;
                render();
            }
        };

        window.saveMxAction = (changeId, actionIndex) => {
            const change = state.internalChanges.find(c => c.id === changeId);
            if (change) {
                const taskInput = document.getElementById(`edit-task-${changeId}-${actionIndex}`).value;
                const ownerInput = document.getElementById(`edit-owner-${changeId}-${actionIndex}`).value;
                const timeInput = document.getElementById(`edit-time-${changeId}-${actionIndex}`).value;
                
                change.actions[actionIndex].task = taskInput;
                change.actions[actionIndex].owner = ownerInput;
                change.actions[actionIndex].time = timeInput;
                change.actions[actionIndex].isEditing = false;
                render();
            }
        };

        window.cancelEditMxAction = (changeId, actionIndex) => {
            const change = state.internalChanges.find(c => c.id === changeId);
            if (change) {
                // If it was a newly added empty task and we cancel, just remove it
                if (!change.actions[actionIndex].task) {
                    change.actions.splice(actionIndex, 1);
                } else {
                    change.actions[actionIndex].isEditing = false;
                }
                render();
            }
        };

        window.addMxAction = (changeId) => {
            const change = state.internalChanges.find(c => c.id === changeId);
            if (change) {
                change.actions.push({ task: '', owner: '', time: '', status: 'Pending', isEditing: true });
                render();
            }
        };

        // ==========================================
        // RENDERING LOGIC
        // ==========================================

        function renderNav() {
            const nav = document.getElementById('nav-menu');
            nav.innerHTML = `
                <button onclick="navigate('dashboard')" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium transition-colors ${state.currentView === 'dashboard' ? 'bg-indigo-600 text-white' : 'hover:bg-slate-800 hover:text-white'}">
                    <i class="ph ph-squares-four text-lg"></i> Dashboard
                </button>
                <button onclick="navigate('intake')" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium transition-colors ${state.currentView === 'intake' ? 'bg-indigo-600 text-white' : 'hover:bg-slate-800 hover:text-white'}">
                    <i class="ph ph-folder-plus text-lg"></i> Engineering Intake
                </button>
                <button onclick="navigate('internal-changes')" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium transition-colors ${state.currentView === 'internal-changes' ? 'bg-indigo-600 text-white' : 'hover:bg-slate-800 hover:text-white'}">
                    <i class="ph ph-swap text-lg"></i> MX Changes
                </button>
                <button class="w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium transition-colors hover:bg-slate-800 hover:text-white opacity-50 cursor-not-allowed" title="Coming Soon">
                    <i class="ph ph-gear text-lg"></i> Configurations
                </button>
            `;
        }

        function renderDashboard() {
            const totalProjects = state.projects.length;
            const blockedProjects = state.projects.filter(p => 
                [...(p.tasks.operations||[]), ...(p.tasks.training||[]), ...(p.tasks.quality||[])].some(t => t.status === 'Blocked')
            ).length;
            
            const avgReadiness = totalProjects > 0 
                ? Math.round(state.projects.reduce((acc, p) => acc + calculateOverallReadiness(p.tasks), 0) / totalProjects)
                : 0;

            let projectsHtml = '';
            if (totalProjects === 0) {
                projectsHtml = `<div class="p-12 text-center text-slate-500">No active projects. Create one to get started.</div>`;
            } else {
                projectsHtml = state.projects.map(project => {
                    const opsReadiness = calculateReadiness(project.tasks.operations);
                    const trnReadiness = calculateReadiness(project.tasks.training);
                    const qaReadiness = calculateReadiness(project.tasks.quality);
                    const overall = calculateOverallReadiness(project.tasks);
                    
                    const impactClass = project.impactLevel === 'High' ? 'bg-red-50 text-red-700 border-red-200' : 
                                        project.impactLevel === 'Medium' ? 'bg-orange-50 text-orange-700 border-orange-200' : 
                                        'bg-green-50 text-green-700 border-green-200';

                    return `
                        <div class="p-6 hover:bg-slate-50 transition-colors cursor-pointer" onclick="openProject('${project.id}')">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h3 class="text-lg font-bold text-indigo-900">${escapeHTML(project.title)}</h3>
                                    <p class="text-sm text-slate-500 mt-1 line-clamp-1">${escapeHTML(project.objective)}</p>
                                </div>
                                <span class="px-3 py-1 rounded-full text-xs font-semibold border ${impactClass}">
                                    ${escapeHTML(project.impactLevel)} Impact
                                </span>
                            </div>
                            
                            <div class="grid grid-cols-4 gap-4 mt-6">
                                <div class="col-span-4 md:col-span-1 border-r border-slate-100 pr-4">
                                    <div class="flex justify-between text-sm mb-1"><span class="font-semibold text-slate-700">Overall</span><span class="text-slate-600">${overall}%</span></div>
                                    <div class="w-full bg-slate-100 rounded-full h-2"><div class="bg-indigo-600 h-2 rounded-full transition-all duration-500" style="width: ${overall}%"></div></div>
                                </div>
                                <div class="col-span-4 md:col-span-1 border-r border-slate-100 pr-4">
                                    <div class="flex justify-between text-sm mb-1"><span class="text-slate-600 flex items-center gap-1"><i class="ph ph-users"></i> Ops</span><span class="text-slate-600">${opsReadiness}%</span></div>
                                    <div class="w-full bg-slate-100 rounded-full h-2"><div class="bg-blue-500 h-2 rounded-full transition-all duration-500" style="width: ${opsReadiness}%"></div></div>
                                </div>
                                <div class="col-span-4 md:col-span-1 border-r border-slate-100 pr-4">
                                    <div class="flex justify-between text-sm mb-1"><span class="text-slate-600 flex items-center gap-1"><i class="ph ph-book-open"></i> Training</span><span class="text-slate-600">${trnReadiness}%</span></div>
                                    <div class="w-full bg-slate-100 rounded-full h-2"><div class="bg-amber-500 h-2 rounded-full transition-all duration-500" style="width: ${trnReadiness}%"></div></div>
                                </div>
                                <div class="col-span-4 md:col-span-1">
                                    <div class="flex justify-between text-sm mb-1"><span class="text-slate-600 flex items-center gap-1"><i class="ph ph-crosshair"></i> Quality</span><span class="text-slate-600">${qaReadiness}%</span></div>
                                    <div class="w-full bg-slate-100 rounded-full h-2"><div class="bg-emerald-500 h-2 rounded-full transition-all duration-500" style="width: ${qaReadiness}%"></div></div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            return `
                <div class="space-y-6 fade-in">
                    <header class="mb-8">
                        <h1 class="text-2xl font-bold text-slate-800">Change Readiness Dashboard</h1>
                        <p class="text-slate-500">Overview of all active integrations and operational readiness.</p>
                    </header>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center space-x-4">
                            <div class="p-3 bg-indigo-100 rounded-lg text-indigo-600"><i class="ph-bold ph-folder-plus text-2xl"></i></div>
                            <div><p class="text-sm font-medium text-slate-500">Active Integrations</p><h3 class="text-2xl font-bold text-slate-800">${totalProjects}</h3></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center space-x-4">
                            <div class="p-3 bg-emerald-100 rounded-lg text-emerald-600"><i class="ph-bold ph-crosshair text-2xl"></i></div>
                            <div><p class="text-sm font-medium text-slate-500">Avg Global Readiness</p><h3 class="text-2xl font-bold text-slate-800">${avgReadiness}%</h3></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center space-x-4">
                            <div class="p-3 bg-rose-100 rounded-lg text-rose-600"><i class="ph-bold ph-warning-circle text-2xl"></i></div>
                            <div><p class="text-sm font-medium text-slate-500">Blocked Workstreams</p><h3 class="text-2xl font-bold text-slate-800">${blockedProjects}</h3></div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <div class="p-6 border-b border-slate-200"><h2 class="text-lg font-bold text-slate-800">Active Projects</h2></div>
                        <div class="divide-y divide-slate-100">${projectsHtml}</div>
                    </div>
                </div>
            `;
        }

        function renderIntake() {
            const manualClass = state.importType === 'manual' ? 'border-indigo-500 bg-indigo-50 text-indigo-700' : 'border-slate-200 text-slate-600 hover:bg-slate-50';
            const confClass = state.importType === 'confluence' ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-slate-200 text-slate-600 hover:bg-slate-50';
            const docsClass = state.importType === 'gdocs' ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-slate-200 text-slate-600 hover:bg-slate-50';
            
            let importSectionHtml = '';
            
            if (state.importType === 'confluence') {
                const prdRows = state.fetchedPRDs.map(prd => `
                    <tr class="border-b border-slate-100 hover:bg-slate-50 transition-colors group">
                        <td class="py-3 pr-4">
                            <div class="flex items-center gap-2">
                                <i class="ph-fill ph-file-text text-blue-500"></i>
                                <span class="text-sm font-medium text-[#0052CC] hover:underline cursor-pointer" onclick="selectPRD('${prd.id}')">${escapeHTML(prd.title)}</span>
                            </div>
                        </td>
                        <td class="py-3 px-4 text-xs text-[#5E6C84] hidden sm:table-cell">${escapeHTML(prd.category)}</td>
                        <td class="py-3 px-4 text-xs text-[#5E6C84]">${escapeHTML(prd.timeline)}</td>
                        <td class="py-3 pl-4 text-right">
                            <button type="button" onclick="selectPRD('${prd.id}')" class="opacity-0 group-hover:opacity-100 transition-opacity text-xs font-bold text-white bg-[#0052CC] hover:bg-[#0047B3] px-3 py-1.5 rounded-md flex items-center gap-1 ml-auto">
                                <i class="ph-bold ph-magic-wand"></i> Import
                            </button>
                        </td>
                    </tr>
                `).join('');

                importSectionHtml = `
                    <div class="mt-6 border border-[#DFE1E6] rounded-lg overflow-hidden flex flex-col md:flex-row h-[450px] bg-white shadow-sm fade-in">
                        <!-- Confluence Sidebar -->
                        <div class="w-full md:w-64 bg-[#F4F5F7] border-r border-[#DFE1E6] p-4 overflow-y-auto shrink-0 hidden md:block">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="w-8 h-8 rounded bg-gradient-to-br from-blue-500 to-blue-700 text-white flex items-center justify-center text-sm font-bold shadow-sm">P</div>
                                <div>
                                    <span class="text-sm font-bold text-[#172B4D] block">Product (PROD)</span>
                                    <span class="text-[10px] text-[#5E6C84] uppercase tracking-wider font-semibold">Software Project</span>
                                </div>
                            </div>
                            <div class="text-[11px] text-[#5E6C84] font-bold mb-2 uppercase tracking-wider">Pages</div>
                            <ul class="space-y-0.5 text-sm text-[#42526E] font-medium">
                                <li class="flex items-center gap-2 py-1.5 px-2 hover:bg-[#EBECF0] rounded cursor-pointer transition-colors"><i class="ph-fill ph-caret-right text-[#A5ADBA]"></i> Product Strategy</li>
                                <li class="flex items-center gap-2 py-1.5 px-2 bg-[#E6FCFF] text-[#0052CC] rounded cursor-pointer transition-colors"><i class="ph-fill ph-caret-down"></i> PRDs - Product Require...</li>
                                <ul class="pl-6 space-y-0.5 mt-0.5 border-l border-[#DFE1E6] ml-3">
                                    ${state.fetchedPRDs.map(prd => `<li onclick="selectPRD('${prd.id}')" class="py-1 px-2 hover:bg-[#EBECF0] rounded cursor-pointer text-[#42526E] text-xs truncate transition-colors">${escapeHTML(prd.title)}</li>`).join('')}
                                </ul>
                                <li class="flex items-center gap-2 py-1.5 px-2 hover:bg-[#EBECF0] rounded cursor-pointer transition-colors mt-1"><i class="ph-fill ph-caret-right text-[#A5ADBA]"></i> Meeting Notes</li>
                                <li class="flex items-center gap-2 py-1.5 px-2 hover:bg-[#EBECF0] rounded cursor-pointer transition-colors"><i class="ph-fill ph-caret-right text-[#A5ADBA]"></i> Retrospectives</li>
                            </ul>
                        </div>
                        <!-- Confluence Main Content -->
                        <div class="flex-1 p-6 lg:p-8 overflow-y-auto bg-white relative custom-scrollbar">
                            <div class="flex items-center text-sm text-[#5E6C84] mb-4 gap-2">
                                <span class="hover:underline cursor-pointer">Pages</span>
                                <span>/</span>
                                <span class="hover:underline cursor-pointer">Product (PROD)</span>
                            </div>
                            <h2 class="text-2xl font-bold text-[#172B4D] mb-6 flex items-center gap-2">
                                PRDs - Product Requirement Documents
                            </h2>
                            
                            <div class="prose prose-sm text-[#091E42] max-w-none mb-8">
                                <p>This page serves as the master directory for all active Product Requirement Documents within the PROD space. Select a PRD to import it directly into the ChangeSync workflow.</p>
                            </div>

                            <div class="border border-[#DFE1E6] rounded-lg overflow-hidden">
                                <table class="w-full text-left border-collapse">
                                    <thead class="bg-[#F4F5F7] border-b border-[#DFE1E6]">
                                        <tr>
                                            <th class="py-2.5 px-4 text-xs font-bold text-[#5E6C84] uppercase">Title</th>
                                            <th class="py-2.5 px-4 text-xs font-bold text-[#5E6C84] uppercase hidden sm:table-cell">Category</th>
                                            <th class="py-2.5 px-4 text-xs font-bold text-[#5E6C84] uppercase">Target Date</th>
                                            <th class="py-2.5 px-4 text-xs font-bold text-[#5E6C84] uppercase text-right">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${prdRows}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            } else if (state.importType === 'gdocs') {
                const placeholder = 'https://docs.google.com/document/d/...';
                const label = 'Google Document URL';
                
                importSectionHtml = `
                    <div class="flex gap-3 items-end p-4 bg-slate-50 rounded-lg border border-slate-200 fade-in mt-4">
                        <div class="flex-1">
                            <label class="block text-xs font-semibold text-slate-500 mb-1 uppercase tracking-wider">${label}</label>
                            <div class="relative">
                                <i class="ph-bold ph-link absolute left-3 top-3 text-slate-400"></i>
                                <input type="url" value="${escapeHTML(state.importUrl)}" oninput="handleImportUrlInput(this.value)" placeholder="${placeholder}" class="w-full pl-9 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none bg-white"/>
                            </div>
                        </div>
                        <button type="button" id="import-btn" onclick="handleImport()" ${!state.importUrl || state.isImporting ? 'disabled' : ''} class="bg-indigo-600 hover:bg-indigo-700 disabled:bg-slate-400 text-white px-6 py-2 rounded-lg font-medium transition-colors flex items-center justify-center gap-2 h-[42px] min-w-[180px]">
                            ${state.isImporting ? '<i class="ph-bold ph-spinner animate-spin"></i> Analyzing with AI...' : '<i class="ph-bold ph-magic-wand"></i> AI Fetch & Auto-fill'}
                        </button>
                    </div>
                `;
            }

            const autoBadge = (state.formData.title && state.importType === 'confluence') ? `<span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full font-bold ml-2 flex items-center gap-1"><i class="ph-fill ph-check-circle"></i> Imported from Confluence</span>` : '';

            return `
                <div class="max-w-4xl mx-auto space-y-6 fade-in pb-10">
                    <header class="mb-8">
                        <h1 class="text-2xl font-bold text-slate-800">New Change Intake</h1>
                        <p class="text-slate-500">Submit engineering inputs to auto-generate operational workstreams.</p>
                    </header>

                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h2 class="text-sm font-bold text-slate-800 mb-4">How would you like to create this intake?</h2>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <button type="button" onclick="setImportType('manual')" class="flex-1 py-3 px-4 rounded-lg border flex items-center justify-center gap-2 font-medium transition-colors ${manualClass}">
                                <i class="ph-bold ph-list-checks"></i> Manual Entry
                            </button>
                            <button type="button" onclick="setImportType('confluence')" class="flex-1 py-3 px-4 rounded-lg border flex items-center justify-center gap-2 font-medium transition-colors ${confClass}">
                                <i class="ph-bold ph-globe"></i> Confluence Sync
                            </button>
                            <button type="button" onclick="setImportType('gdocs')" class="flex-1 py-3 px-4 rounded-lg border flex items-center justify-center gap-2 font-medium transition-colors ${docsClass}">
                                <i class="ph-bold ph-file-text"></i> Google Docs URL
                            </button>
                        </div>
                        ${importSectionHtml}
                    </div>

                    <form id="intake-form" onsubmit="handleFormSubmit(event)" class="bg-white p-8 rounded-xl border border-slate-200 shadow-sm space-y-6">
                        <div class="flex items-center gap-2 mb-2">
                            <h2 class="text-lg font-bold text-slate-800">Project Details</h2>
                            ${autoBadge}
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1">Project Title</label>
                                <input required type="text" value="${escapeHTML(state.formData.title)}" oninput="handleFormInput('title', this.value)" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="e.g. Q4 Platform Migration" />
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-1">Target Launch Date</label>
                                    <input required type="date" value="${escapeHTML(state.formData.timeline)}" oninput="handleFormInput('timeline', this.value)" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" />
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-1">Risk / Impact Level</label>
                                    <select oninput="handleFormInput('riskLevel', this.value)" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                                        <option value="Low" ${state.formData.riskLevel === 'Low' ? 'selected' : ''}>Low (Process tweak)</option>
                                        <option value="Medium" ${state.formData.riskLevel === 'Medium' ? 'selected' : ''}>Medium (Cross-functional update)</option>
                                        <option value="High" ${state.formData.riskLevel === 'High' ? 'selected' : ''}>High (Multi-team rollout)</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1">Objective</label>
                                <textarea required rows="2" oninput="handleFormInput('objective', this.value)" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="What is the business goal?">${escapeHTML(state.formData.objective)}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1">Scope & Dependencies</label>
                                <textarea rows="2" oninput="handleFormInput('scope', this.value)" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="Who is affected? What other projects does this depend on?">${escapeHTML(state.formData.scope)}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1">Technical Summary</label>
                                <textarea required rows="3" oninput="handleFormInput('techSummary', this.value)" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="Brief technical overview from Engineering...">${escapeHTML(state.formData.techSummary)}</textarea>
                            </div>
                        </div>
                        <div class="pt-4 border-t border-slate-100 flex justify-end">
                            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-medium transition-colors flex items-center gap-2">
                                <i class="ph-bold ph-rocket"></i> Generate Workstreams
                            </button>
                        </div>
                    </form>
                </div>
            `;
        }

        function renderProjectDetail() {
            const project = state.projects.find(p => p.id === state.selectedProjectId);
            if (!project) return '';

            const overall = calculateOverallReadiness(project.tasks);
            
            const renderTaskRow = (task, dept) => {
                const getStatusColor = (status) => {
                    switch(status) {
                        case 'Completed': return 'text-green-600 bg-green-50 border-green-200';
                        case 'In Progress': return 'text-blue-600 bg-blue-50 border-blue-200';
                        case 'Blocked': return 'text-red-600 bg-red-50 border-red-200';
                        default: return 'text-gray-600 bg-gray-50 border-gray-200';
                    }
                };
                
                const getStatusIconHtml = (status) => {
                    switch(status) {
                        case 'Completed': return '<i class="ph-fill ph-check-circle text-green-600"></i>';
                        case 'In Progress': return '<i class="ph-fill ph-clock text-blue-600"></i>';
                        case 'Blocked': return '<i class="ph-fill ph-x-circle text-red-600"></i>';
                        default: return '<i class="ph-fill ph-warning-circle text-gray-400"></i>';
                    }
                };

                return `
                    <div class="flex items-center justify-between p-3 hover:bg-slate-50 border-b border-slate-100 last:border-0 transition-colors">
                        <div class="flex items-center gap-3 w-1/3">
                            ${getStatusIconHtml(task.status)}
                            <span class="text-sm font-medium ${task.status === 'Completed' ? 'text-slate-400 line-through' : 'text-slate-700'}">
                                ${escapeHTML(task.title)}
                            </span>
                        </div>
                        <div class="w-1/4">
                            <input type="text" placeholder="Assign Owner..." value="${escapeHTML(task.owner)}" onchange="updateTaskDetail('${project.id}', '${dept}', '${task.id}', 'owner', this.value)" class="text-sm bg-transparent border-b border-transparent hover:border-slate-300 focus:border-indigo-500 focus:outline-none w-full px-1"/>
                        </div>
                        <div class="w-1/6">
                            <input type="date" value="${escapeHTML(task.dueDate)}" onchange="updateTaskDetail('${project.id}', '${dept}', '${task.id}', 'dueDate', this.value)" class="text-sm bg-transparent border-none text-slate-500 focus:outline-none"/>
                        </div>
                        <div class="w-1/4 flex justify-end">
                            <select onchange="updateTaskStatus('${project.id}', '${dept}', '${task.id}', this.value)" class="text-xs font-semibold px-2 py-1 rounded-full border focus:outline-none appearance-none cursor-pointer ${getStatusColor(task.status)}">
                                <option value="Not Started" ${task.status === 'Not Started' ? 'selected' : ''}>Not Started</option>
                                <option value="In Progress" ${task.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                <option value="Blocked" ${task.status === 'Blocked' ? 'selected' : ''}>Blocked</option>
                                <option value="Completed" ${task.status === 'Completed' ? 'selected' : ''}>Completed</option>
                            </select>
                        </div>
                    </div>
                `;
            };

            const impactClass = project.impactLevel === 'High' ? 'bg-red-50 text-red-700 border-red-200' : 
                                project.impactLevel === 'Medium' ? 'bg-orange-50 text-orange-700 border-orange-200' : 
                                'bg-green-50 text-green-700 border-green-200';

            const gateClass = project.approvalGate === 'Go' ? 'bg-emerald-500 text-white hover:bg-emerald-600' : 'bg-slate-200 text-slate-700 hover:bg-slate-300';
            const gateText = project.approvalGate === 'Go' ? 'GO APPROVED' : 'NO-GO / PENDING';

            return `
                <div class="space-y-6 fade-in">
                    <button onclick="navigate('dashboard')" class="text-sm text-indigo-600 hover:text-indigo-800 flex items-center gap-1 font-medium mb-4">
                        <i class="ph-bold ph-caret-left"></i> Back to Dashboard
                    </button>

                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h1 class="text-2xl font-bold text-slate-900">${escapeHTML(project.title)}</h1>
                                <p class="text-slate-500 mt-1">${escapeHTML(project.objective)}</p>
                            </div>
                            <div class="text-right">
                                <div class="text-3xl font-bold text-indigo-600">${overall}%</div>
                                <div class="text-sm text-slate-500 font-medium">Global Readiness</div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 pt-4 border-t border-slate-100 mt-4">
                            <div>
                                <p class="text-xs text-slate-400 font-semibold uppercase tracking-wider mb-1">Target Date</p>
                                <p class="text-sm font-medium text-slate-800">${escapeHTML(project.timeline)}</p>
                            </div>
                            <div>
                                <p class="text-xs text-slate-400 font-semibold uppercase tracking-wider mb-1">Impact Level</p>
                                <span class="px-2 py-0.5 rounded text-xs font-semibold border ${impactClass}">${escapeHTML(project.impactLevel)}</span>
                            </div>
                            <div class="flex items-center justify-start md:justify-end gap-3">
                                <span class="text-sm font-semibold text-slate-700">Launch Gate:</span>
                                <button onclick="updateApprovalGate('${project.id}')" class="px-4 py-1.5 rounded-lg text-sm font-bold shadow-sm transition-colors ${gateClass}">
                                    ${gateText}
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <!-- Operations -->
                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                            <div class="bg-slate-50 p-4 border-b border-slate-200 flex justify-between items-center">
                                <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="ph-bold ph-users text-blue-500"></i> Operations Workstream</h2>
                                <span class="text-sm font-bold text-blue-600 bg-blue-100 px-3 py-1 rounded-full">${calculateReadiness(project.tasks.operations)}% Ready</span>
                            </div>
                            <div class="p-2 w-full overflow-x-auto">
                                <div class="min-w-[600px]">
                                    <div class="flex text-xs font-semibold text-slate-400 uppercase px-3 py-2">
                                        <div class="w-1/3">Deliverable</div><div class="w-1/4">Owner</div><div class="w-1/6">Target</div><div class="w-1/4 text-right pr-2">Status</div>
                                    </div>
                                    ${project.tasks.operations.map(t => renderTaskRow(t, 'operations')).join('')}
                                </div>
                            </div>
                        </div>

                        <!-- Training -->
                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                            <div class="bg-slate-50 p-4 border-b border-slate-200 flex justify-between items-center">
                                <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="ph-bold ph-book-open text-amber-500"></i> Training Workstream</h2>
                                <span class="text-sm font-bold text-amber-600 bg-amber-100 px-3 py-1 rounded-full">${calculateReadiness(project.tasks.training)}% Ready</span>
                            </div>
                            <div class="p-2 w-full overflow-x-auto">
                                <div class="min-w-[600px]">
                                    <div class="flex text-xs font-semibold text-slate-400 uppercase px-3 py-2">
                                        <div class="w-1/3">Deliverable</div><div class="w-1/4">Owner</div><div class="w-1/6">Target</div><div class="w-1/4 text-right pr-2">Status</div>
                                    </div>
                                    ${project.tasks.training.map(t => renderTaskRow(t, 'training')).join('')}
                                </div>
                            </div>
                        </div>

                        <!-- Quality -->
                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                            <div class="bg-slate-50 p-4 border-b border-slate-200 flex justify-between items-center">
                                <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="ph-bold ph-crosshair text-emerald-500"></i> Quality Workstream</h2>
                                <span class="text-sm font-bold text-emerald-600 bg-emerald-100 px-3 py-1 rounded-full">${calculateReadiness(project.tasks.quality)}% Ready</span>
                            </div>
                            <div class="p-2 w-full overflow-x-auto">
                                <div class="min-w-[600px]">
                                    <div class="flex text-xs font-semibold text-slate-400 uppercase px-3 py-2">
                                        <div class="w-1/3">Deliverable</div><div class="w-1/4">Owner</div><div class="w-1/6">Target</div><div class="w-1/4 text-right pr-2">Status</div>
                                    </div>
                                    ${project.tasks.quality.map(t => renderTaskRow(t, 'quality')).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderInternalChanges() {
            if (state.showInternalChangeForm) {
                return `
                    <div class="max-w-3xl mx-auto space-y-6 fade-in">
                        <button onclick="toggleInternalChangeForm(false)" class="text-sm text-indigo-600 hover:text-indigo-800 flex items-center gap-1 font-medium mb-4">
                            <i class="ph-bold ph-caret-left"></i> Back to MX Changes
                        </button>
                        
                        <header class="mb-8">
                            <h1 class="text-2xl font-bold text-slate-800">Change Management Form - MX</h1>
                            <p class="text-slate-500">Submit an internal process, workflow, or tooling change.</p>
                        </header>

                        <form onsubmit="submitInternalChange(event)" class="bg-white p-8 rounded-xl border border-slate-200 shadow-sm space-y-6">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-1">What is the change required?</label>
                                    <input required type="text" value="${escapeHTML(state.internalFormData.title)}" oninput="handleInternalChangeInput('title', this.value)" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="Brief title of the change" />
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-1">Which Team is impacted?</label>
                                        <select oninput="handleInternalChangeInput('team', this.value)" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                                            <option value="All Tiers" ${state.internalFormData.team === 'All Tiers' ? 'selected' : ''}>All Tiers</option>
                                            <option value="Tier 1" ${state.internalFormData.team === 'Tier 1' ? 'selected' : ''}>Tier 1</option>
                                            <option value="Tier 2" ${state.internalFormData.team === 'Tier 2' ? 'selected' : ''}>Tier 2</option>
                                            <option value="Mentors/Leads" ${state.internalFormData.team === 'Mentors/Leads' ? 'selected' : ''}>Mentors / Leads</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-1">System/Tools or Workflow?</label>
                                        <select oninput="handleInternalChangeInput('type', this.value)" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                                            <option value="Workflow" ${state.internalFormData.type === 'Workflow' ? 'selected' : ''}>Workflow</option>
                                            <option value="System/Tools" ${state.internalFormData.type === 'System/Tools' ? 'selected' : ''}>System / Tools</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-1">When is this going to happen?</label>
                                        <input required type="datetime-local" value="${escapeHTML(state.internalFormData.date)}" oninput="handleInternalChangeInput('date', this.value)" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-1">Submitter Name</label>
                                        <input required type="text" value="${escapeHTML(state.internalFormData.submitter)}" oninput="handleInternalChangeInput('submitter', this.value)" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="Your name"/>
                                    </div>
                                </div>
                                
                                <div class="p-4 bg-slate-50 border border-slate-200 rounded-lg">
                                    <label class="block text-sm font-semibold text-slate-700 mb-1">Size of Impact</label>
                                    <select oninput="handleInternalChangeInput('impact', this.value)" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none mb-2">
                                        <option value="Minor" ${state.internalFormData.impact === 'Minor' ? 'selected' : ''}>Minor (SOP wordings, minor steps)</option>
                                        <option value="Major" ${state.internalFormData.impact === 'Major' ? 'selected' : ''}>Major (Tool changes, workflow shifts, discounts)</option>
                                        <option value="Critical" ${state.internalFormData.impact === 'Critical' ? 'selected' : ''}>Critical (Urgent, ToS updates, Product releases)</option>
                                    </select>
                                    
                                    <label class="flex items-center gap-2 mt-3 cursor-pointer">
                                        <input type="checkbox" onchange="handleInternalChangeCheckbox('isCustomerFacing', this.checked)" ${state.internalFormData.isCustomerFacing ? 'checked' : ''} class="w-4 h-4 text-indigo-600 border-slate-300 rounded focus:ring-indigo-500">
                                        <span class="text-sm font-semibold text-slate-700">Customer Facing Impact (Website, Marketing, Policy)</span>
                                    </label>
                                </div>

                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-1">Describe the change and Customer Impact</label>
                                    <textarea required rows="3" oninput="handleInternalChangeInput('description', this.value)" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">${escapeHTML(state.internalFormData.description)}</textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-1">Links / Documents / Screenshots URLs</label>
                                    <input type="url" value="${escapeHTML(state.internalFormData.link)}" oninput="handleInternalChangeInput('link', this.value)" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="https://..." />
                                </div>
                            </div>
                            <div class="pt-4 border-t border-slate-100 flex justify-end">
                                <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-medium transition-colors flex items-center gap-2">
                                    <i class="ph-bold ph-paper-plane-tilt"></i> Submit Change
                                </button>
                            </div>
                        </form>
                    </div>
                `;
            }

            // List View
            const listHtml = state.internalChanges.map(change => {
                const isExpanded = state.expandedChangeId === change.id;
                
                const impactClass = change.impact === 'Critical' ? 'bg-red-100 text-red-800' : 
                                    change.impact === 'Major' ? 'bg-orange-100 text-orange-800' : 'bg-green-100 text-green-800';

                let formattedDate = change.date;
                try { 
                    if(change.date && change.date !== 'Pending') {
                        formattedDate = new Date(change.date).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }); 
                    }
                } catch(e) {}

                const actionsHtml = change.actions.map((a, index) => {
                    if (a.isEditing) {
                        return `
                            <div class="flex flex-col gap-2 py-3 border-b border-slate-100 last:border-0 bg-slate-50 p-3 rounded-lg animate-fadeIn">
                                <input type="text" id="edit-task-${change.id}-${index}" value="${escapeHTML(a.task)}" class="w-full p-2 text-sm border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Task description..." />
                                <div class="flex gap-2">
                                    <div class="w-1/2">
                                        <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Owner</label>
                                        <input type="text" id="edit-owner-${change.id}-${index}" value="${escapeHTML(a.owner)}" class="w-full p-2 text-xs border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="e.g. Change Owner" />
                                    </div>
                                    <div class="w-1/2">
                                        <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Time/Duration</label>
                                        <input type="text" id="edit-time-${change.id}-${index}" value="${escapeHTML(a.time)}" class="w-full p-2 text-xs border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="e.g. 15m" />
                                    </div>
                                </div>
                                <div class="flex justify-end gap-2 mt-2">
                                    <button type="button" onclick="cancelEditMxAction('${change.id}', ${index})" class="text-xs px-3 py-1.5 text-slate-600 font-medium hover:bg-slate-200 rounded transition-colors">Cancel</button>
                                    <button type="button" onclick="saveMxAction('${change.id}', ${index})" class="text-xs px-3 py-1.5 bg-indigo-600 text-white font-medium rounded hover:bg-indigo-700 transition-colors">Save Task</button>
                                </div>
                            </div>
                        `;
                    }

                    return `
                        <div class="flex items-start gap-3 py-3 border-b border-slate-100 last:border-0 group relative">
                            <input type="checkbox" class="mt-1 border-slate-300 text-indigo-600 rounded focus:ring-indigo-500 cursor-pointer">
                            <div class="flex-1">
                                <p class="text-sm font-medium text-slate-800">${escapeHTML(a.task)}</p>
                                <p class="text-xs text-slate-500 mt-0.5">Owner: ${escapeHTML(a.owner)} â€¢ Avg Time: ${escapeHTML(a.time)}</p>
                            </div>
                            <div class="opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1">
                                <button onclick="editMxAction('${change.id}', ${index})" class="p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded transition-colors" title="Edit">
                                    <i class="ph-bold ph-pencil-simple"></i>
                                </button>
                                <button onclick="deleteMxAction('${change.id}', ${index})" class="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors" title="Delete">
                                    <i class="ph-bold ph-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                const expandedHtml = isExpanded ? `
                    <div class="mt-4 pt-4 border-t border-slate-100 animate-fadeIn">
                        <div class="mb-4">
                            <h4 class="text-xs font-bold uppercase text-slate-400 mb-1">Description</h4>
                            <p class="text-sm text-slate-700 bg-slate-50 p-3 rounded-lg border border-slate-200">${escapeHTML(change.description)}</p>
                        </div>
                        ${change.link ? `
                        <div class="mb-6">
                            <h4 class="text-xs font-bold uppercase text-slate-400 mb-1">Attachments / Links</h4>
                            <a href="${escapeHTML(change.link)}" target="_blank" class="text-sm text-indigo-600 hover:underline flex items-center gap-1"><i class="ph ph-link"></i> External Reference Link</a>
                        </div>` : ''}
                        
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <h4 class="text-sm font-bold text-slate-800"><i class="ph-fill ph-list-checks text-indigo-500"></i> Auto-Generated Change Plan</h4>
                                <span class="text-[10px] bg-slate-100 text-slate-600 px-2 py-0.5 rounded-full font-semibold uppercase tracking-wider">Based on ${change.impact} Impact</span>
                            </div>
                            <div class="bg-white border border-slate-200 rounded-lg p-3">
                                ${actionsHtml}
                                <button onclick="addMxAction('${change.id}')" class="mt-2 w-full py-2 border-2 border-dashed border-slate-200 text-slate-500 rounded-lg text-sm font-medium hover:bg-slate-50 hover:border-indigo-300 hover:text-indigo-600 transition-colors flex items-center justify-center gap-2">
                                    <i class="ph-bold ph-plus"></i> Add Action Item
                                </button>
                            </div>
                        </div>
                    </div>
                ` : '';

                return `
                    <div class="p-5 border-b border-slate-200 last:border-0 hover:bg-slate-50 transition-colors">
                        <div class="flex items-start justify-between cursor-pointer" onclick="toggleInternalChangeDetail('${change.id}')">
                            <div class="flex-1 pr-4">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="px-2 py-0.5 text-xs font-bold rounded ${impactClass}">${escapeHTML(change.impact)}</span>
                                    ${change.isCustomerFacing ? '<span class="px-2 py-0.5 text-xs font-bold rounded bg-purple-100 text-purple-800 flex items-center gap-1"><i class="ph-fill ph-users"></i> Customer Facing</span>' : ''}
                                    <span class="text-xs font-semibold text-slate-500 border border-slate-200 px-2 py-0.5 rounded">${escapeHTML(change.type)}</span>
                                </div>
                                <h3 class="text-lg font-bold text-indigo-900">${escapeHTML(change.title)}</h3>
                                <p class="text-sm text-slate-500 mt-1 flex items-center gap-4">
                                    <span><i class="ph ph-user"></i> ${escapeHTML(change.submitter)}</span>
                                    <span><i class="ph ph-calendar"></i> ${escapeHTML(formattedDate)}</span>
                                    <span><i class="ph ph-users-three"></i> ${escapeHTML(change.team)}</span>
                                </p>
                            </div>
                            <div class="text-slate-400 mt-2">
                                <i class="ph-bold ${isExpanded ? 'ph-caret-up' : 'ph-caret-down'} text-xl"></i>
                            </div>
                        </div>
                        ${expandedHtml}
                    </div>
                `;
            }).join('');

            return `
                <div class="space-y-6 fade-in">
                    <header class="mb-8 flex justify-between items-end">
                        <div>
                            <h1 class="text-2xl font-bold text-slate-800">MX Change Management Hub</h1>
                            <p class="text-slate-500">Track internal workflows, tools, and SOP updates.</p>
                        </div>
                        <button onclick="toggleInternalChangeForm(true)" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center gap-2">
                            <i class="ph-bold ph-plus"></i> New MX Change
                        </button>
                    </header>

                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <div class="p-4 border-b border-slate-200 bg-slate-50">
                            <h2 class="text-sm font-bold text-slate-800">Recent Internal Changes</h2>
                        </div>
                        <div class="divide-y divide-slate-100">
                            ${state.internalChanges.length > 0 ? listHtml : '<div class="p-8 text-center text-slate-500">No internal changes recorded.</div>'}
                        </div>
                    </div>
                </div>
            `;
        }

        function render() {
            renderNav();
            const root = document.getElementById('app-root');
            if (state.currentView === 'dashboard') root.innerHTML = renderDashboard();
            else if (state.currentView === 'intake') root.innerHTML = renderIntake();
            else if (state.currentView === 'internal-changes') root.innerHTML = renderInternalChanges();
            else if (state.currentView === 'project-detail') root.innerHTML = renderProjectDetail();
        }

        // Initialize App
        init();

    </script>
</body>
</html>
